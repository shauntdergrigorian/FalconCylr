# FalconCylr
This is a Powershell script that can be used for deploying and collecting forensic artifacts using Crowdstrike. It utilizes PSFalcon and CyLR, an open source forensic tool created by Alan Orlikoski and Jason Yegge.

## CyLR
You can read more about this tool here: https://github.com/orlikoski/CyLR.

This script was designed for Windows hosts, so you'll need the executable which can be downloaded here: https://github.com/orlikoski/CyLR/releases

## Installation

1. Install PSFalcon (follow instructions here: https://github.com/CrowdStrike/psfalcon/wiki/Installation,-Upgrade-and-Removal#use-the-powershell-gallery)
2. Next, upload the CyLR.exe file to your real time response "put" files. This can be found on your Crowdstrike Falcon dashboard by navigating to the hamburger on the top left, then going to "Host Setup and Management", and then clicking on "Response Scripts and Files". Once here, select "Put Files" (located next to "Custom Scripts") and click the "Upload File" button on the right.
3. Upload the CyLR executable.
4. Next, create an API for this script. You can do this by going back to the hamburger menu and selecting "Support and Resources", and then selecting "API Clients and Keys" found under "Resources and Tools".
5. Once here, click "Add New API Client" and give it a name. Scroll down to the items under "API Scopes" and check the following:
   - Hosts: Read
   - Real time response (admin): Read & Write
   - Real time response: Read & Write
6. Save that and copy the client ID and client secret.
7. Edit the powershell script to include these items on line 6 where it reads `Request-FalconToken -ClientId XXXXX -ClientSecret XXXXX -Cloud XX-X`. Replace the XXXXX next to -ClientId with the one provided from your API. Replace the XXXXX next to -ClientSecret with the client secret provided from your API. Replace the XX-X next to -Cloud with your location (this is the prefix of your Crowdstrike URL, e.g. us-1 or us-2).
8. On line 33, you'll need to define your SFTP server information. In the script, the line should currently read:
```
Invoke-FalconRTR -Command runscript -Arguments '-Raw=```Start-Process C:\CyLR.exe -s [SFTP-SERVER-ADDRESS] -u [SFTP-USER] -p [SFTP-PASSWORD] -Verb runAs```' -HostIds $HostId
```

Replace each part with its respective information, and do not include the [] brackets. **NOTE: If the files are smaller than 4gb, you can just use the `get` command to download them through RTR if SFTP is not available.**

9. Finally, on line 81, replace XXXXX with the name of the folder that files are uploaded to on your SFTP server. This can be excluded if you want, but it helps to know where to look in case somebody else is using it.
10. The script is ready to use. To define a host to use this on, add the hostname to a file named hosts.txt located in the same location as the ps1 file. You can add multiple hosts, with each host on a new line. The loop should cycle through each host until it's done. If a host cannot be reached, it should tell you which ones were unreachable once the script is done.

### TO DO
This script is not complete yet. Machines that need to undergo forensic investigation should be network contained before proceeding. I haven't added that functionality to this script yet. I will be adding that to it next, along with the ability to upload to an S3 bucket. If your hosts are network contained, one work around for now would be to exclude the SFTP upload portion of line 33 by replacing it with this:

``` 
Invoke-FalconRTR -Command runscript -Arguments '-Raw=```Start-Process C:\CyLR.exe -Verb runAs```' -HostIds $HostId
```

The files generated by CyLR will need to be retrieved either manually. If they are under 4gb, they can be retrieved using the `get` command in Crowdstrike's real time response.
